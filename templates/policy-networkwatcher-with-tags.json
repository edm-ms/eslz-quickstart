{
  "$schema": "https://schema.management.azure.com/schemas/2019-08-01/managementGroupDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.4.613.9944",
      "templateHash": "4566492279938198320"
    }
  },
  "parameters": {
    "description": {
      "type": "string",
      "defaultValue": "Deploy network watcher with tags when virtual networks are created"
    },
    "policyName": {
      "type": "string",
      "defaultValue": "Network Watcher with Tags"
    },
    "assignmentName": {
      "type": "string",
      "defaultValue": "NetworkWatcher"
    },
    "nonCompliance": {
      "type": "string",
      "defaultValue": "Deploy network watcher"
    },
    "location": {
      "type": "string",
      "defaultValue": "eastus"
    }
  },
  "functions": [],
  "variables": {
    "tags": "[json('{\r\n    \"Application\": \"Azure Platform Operations\",\r\n    \"Application Owner\": \"Azure Platform Team\",\r\n    \"Cost Center\": \"04152010\",\r\n    \"Contact Email\": \"az-platformops@erickmoore.com\",\r\n    \"Data Classification\": \"Internal\",\r\n    \"Recovery Tier\": \"Tier 2\"\r\n}')]",
    "roles": "[json('{\r\n  \"AgFood Platform Service Contributor\": \"8508508a-4469-4e45-963b-2518ee0bb728\",\r\n  \"API Management Service Contributor\": \"312a565d-c81f-4fd8-895a-4e21e48d571c\",\r\n  \"Application Group Contributor\": \"ca6382a4-1721-4bcf-a114-ff0c70227b6b\",\r\n  \"Application Insights Component Contributor\": \"ae349356-3a1b-4a5e-921d-050484c6347e\",\r\n  \"Attestation Contributor\": \"bbf86eb8-f7b4-4cce-96e4-18cddf81d86e\",\r\n  \"Automation Contributor\": \"f353d9bd-d4a6-484e-a77a-8050b599b867\",\r\n  \"Autonomous Development Platform Data Contributor (Preview)\": \"b8b15564-4fa6-4a59-ab12-03e1d9594795\",\r\n  \"Avere Contributor\": \"4f8fab4f-1852-4a58-a46a-8eaf358af14a\",\r\n  \"Azure Kubernetes Service Contributor Role\": \"ed7f3fbd-7b88-4dd4-9017-9adb7ce333f8\",\r\n  \"Azure Maps Data Contributor\": \"8f5e0ce6-4f7b-4dcf-bddf-e6f48634a204\",\r\n  \"Azure Sentinel Automation Contributor\": \"f4c81013-99ee-4d62-a7ee-b3f1f648599a\",\r\n  \"Azure Sentinel Contributor\": \"ab8e14d6-4a74-4a29-9ba8-549422addade\",\r\n  \"Azure Spring Cloud Config Server Contributor\": \"a06f5c24-21a7-4e1a-aa2b-f19eb6684f5b\",\r\n  \"Azure Spring Cloud Service Registry Contributor\": \"f5880b48-c26d-48be-b172-7927bfa1c8f1\",\r\n  \"Azure VM Managed identities restore Contributor\": \"6ae96244-5829-4925-a7d3-5975537d91dd\",\r\n  \"Backup Contributor\": \"5e467623-bb1f-42f4-a55d-6e525e11384b\",\r\n  \"BizTalk Contributor\": \"5e3c6656-6cfa-4708-81fe-0de47ac73342\",\r\n  \"Blueprint Contributor\": \"41077137-e803-4205-871c-5a86e6a753b4\",\r\n  \"CDN Endpoint Contributor\": \"426e0c7f-0c7e-4658-b36f-ff54d6c29b45\",\r\n  \"CDN Profile Contributor\": \"ec156ff8-a8d1-4d15-830c-5b80698ca432\",\r\n  \"ClearDB MySQL DB Contributor\": \"9106cda0-8a86-4e81-b686-29a22c54effe\",\r\n  \"Cognitive Services Contributor\": \"25fbc0a9-bd7c-42a3-aa1a-3b75d497ee68\",\r\n  \"Cognitive Services Custom Vision Contributor\": \"c1ff6cc2-c111-46fe-8896-e0ef812ad9f3\",\r\n  \"Cognitive Services Speech Contributor\": \"0e75ca1e-0464-4b4d-8b93-68208a576181\",\r\n  \"Collaborative Data Contributor\": \"daa9e50b-21df-454c-94a6-a8050adab352\",\r\n  \"Contributor\": \"b24988ac-6180-42a0-ab88-20f7382dd24c\",\r\n  \"Cost Management Contributor\": \"434105ed-43f6-45c7-a02f-909b2ba83430\",\r\n  \"Data Box Contributor\": \"add466c9-e687-43fc-8d98-dfcf8d720be5\",\r\n  \"Data Factory Contributor\": \"673868aa-7521-48a0-acc6-0f60742d39f5\",\r\n  \"Desktop Virtualization Application Group Contributor\": \"86240b0e-9422-4c43-887b-b61143f32ba8\",\r\n  \"Desktop Virtualization Contributor\": \"082f0a83-3be5-4ba1-904c-961cca79b387\",\r\n  \"Desktop Virtualization Host Pool Contributor\": \"e307426c-f9b6-4e81-87de-d99efb3c32bc\",\r\n  \"Desktop Virtualization Workspace Contributor\": \"21efdde3-836f-432b-bf3d-3e8e734d4b2b\",\r\n  \"Device Provisioning Service Data Contributor\": \"dfce44e4-17b7-4bd1-a6d1-04996ec95633\",\r\n  \"Disk Snapshot Contributor\": \"7efff54f-a5b4-42b5-a1c5-5411624893ce\",\r\n  \"DNS Zone Contributor\": \"befefa01-2a29-4197-83a8-272ff33ce314\",\r\n  \"DocumentDB Account Contributor\": \"5bd9cd88-fe45-4216-938b-f97437e15450\",\r\n  \"EventGrid Contributor\": \"1e241071-0855-49ea-94dc-649edcd759de\",\r\n  \"EventGrid EventSubscription Contributor\": \"428e0ff0-5e57-4d9c-a221-2c70d0e0a443\",\r\n  \"Experimentation Contributor\": \"7f646f1b-fa08-80eb-a22b-edd6ce5c915c\",\r\n  \"Experimentation Metric Contributor\": \"6188b7c9-7d01-4f99-a59f-c88b630326c0\",\r\n  \"FHIR Data Contributor\": \"5a1fc7df-4bf1-4951-a576-89034ee01acd\",\r\n  \"HDInsight Domain Services Contributor\": \"8d8d5a11-05d3-4bda-a417-a08778121c7c\",\r\n  \"Integration Service Environment Contributor\": \"a41e2c5b-bd99-4a07-88f4-9bf657a760b8\",\r\n  \"Intelligent Systems Account Contributor\": \"03a6d094-3444-4b3d-88af-7477090a9e5e\",\r\n  \"IoT Hub Data Contributor\": \"4fc6c259-987e-4a07-842e-c321cc9d413f\",\r\n  \"IoT Hub Registry Contributor\": \"4ea46cd5-c1b2-4a8e-910b-273211f9ce47\",\r\n  \"IoT Hub Twin Contributor\": \"494bdba2-168f-4f31-a0a1-191d2f7c028c\",\r\n  \"Key Vault Contributor\": \"f25e0fa2-a7c8-4377-a976-54943a77a395\",\r\n  \"Kubernetes Extension Contributor\": \"85cb6faf-e071-4c9b-8136-154b5a04f717\",\r\n  \"Log Analytics Contributor\": \"92aaf0da-9dab-42b6-94a3-d43ce8d16293\",\r\n  \"Logic App Contributor\": \"87a39d53-fc1b-424a-814c-f7e04687dc9e\",\r\n  \"Managed Application Contributor Role\": \"641177b8-a67a-45b9-a033-47bc880bb21e\",\r\n  \"Managed HSM contributor\": \"18500a29-7fe2-46b2-a342-b16a415e101d\",\r\n  \"Managed Identity Contributor\": \"e40ec5ca-96e0-45a2-b4ff-59039f2c2b59\",\r\n  \"Management Group Contributor\": \"5d58bcaf-24a5-4b20-bdb6-eed9f69fbe4c\",\r\n  \"Monitoring Contributor\": \"749f88d5-cbae-40b8-bcfc-e573ddc772fa\",\r\n  \"Network Contributor\": \"4d97b98b-1d4f-4787-a291-c67834d212e7\",\r\n  \"New Relic APM Account Contributor\": \"5d28c62d-5b37-4476-8438-e587778df237\",\r\n  \"Private DNS Zone Contributor\": \"b12aa53e-6015-4669-85d0-8515ebb3ae7f\",\r\n  \"Redis Cache Contributor\": \"e0f68234-74aa-48ed-b826-c38b57376e17\",\r\n  \"Resource Policy Contributor\": \"36243c78-bf99-498c-9df9-86d9f8d28608\",\r\n  \"Scheduler Job Collections Contributor\": \"188a0f2f-5c9e-469b-ae67-2aa5ce574b94\",\r\n  \"Schema Registry Contributor (Preview)\": \"5dffeca3-4936-4216-b2bc-10343a5abb25\",\r\n  \"Search Index Data Contributor\": \"8ebe5a00-799e-43f5-93ac-243d3dce84a7\",\r\n  \"Search Service Contributor\": \"7ca78c08-252a-4471-8644-bb5ff32d4ba0\",\r\n  \"Security Assessment Contributor\": \"612c2aa1-cb24-443b-ac28-3ab7272de6f5\",\r\n  \"SignalR/Web PubSub Contributor\": \"8cf5e20a-e4b2-4e9d-b3a1-5ceb692c2761\",\r\n  \"Site Recovery Contributor\": \"6670b86e-a3f7-4917-ac9b-5d6ab1be4567\",\r\n  \"Spatial Anchors Account Contributor\": \"8bbe83f1-e2a6-4df7-8cb4-4e04d4e5c827\",\r\n  \"SQL DB Contributor\": \"9b7fa17d-e63e-47b0-bb0a-15c516ac86ec\",\r\n  \"SQL Managed Instance Contributor\": \"4939a1f6-9ae0-4e48-a1e0-f2cbe897382d\",\r\n  \"SQL Server Contributor\": \"6d8ee4ec-f05a-4a1d-8b00-a9b17e38b437\",\r\n  \"Storage Account Backup Contributor Role\": \"e5e2a7ff-d759-4cd2-bb51-3152d37e2eb1\",\r\n  \"Storage Account Contributor\": \"17d1049b-9a84-46fb-8f53-869881c3d3ab\",\r\n  \"Storage Blob Data Contributor\": \"ba92f5b4-2d11-453d-a403-e96b0029c9fe\",\r\n  \"Storage File Data SMB Share Contributor\": \"0c867c2a-1d8c-454a-a3db-ab2ea1bdc8bb\",\r\n  \"Storage File Data SMB Share Elevated Contributor\": \"a7264617-510b-434b-a828-9731dc254ea7\",\r\n  \"Storage Queue Data Contributor\": \"974c5e8b-45b9-4653-ba55-5f855dd0fb88\",\r\n  \"Storage Table Data Contributor\": \"0a9a7e1f-b9d0-4cc4-a60d-0319b160aaa3\",\r\n  \"Support Request Contributor\": \"cfd33db0-3dd1-45e3-aa9d-cdbdf3b6f24e\",\r\n  \"Tag Contributor\": \"4a9ae827-6dc8-4573-8ac7-8239d42aa03f\",\r\n  \"Traffic Manager Contributor\": \"a4b10055-b0c7-44c2-b00f-c7b5b3550cf7\",\r\n  \"Virtual Machine Contributor\": \"9980e02c-c2be-4d73-94e8-173b1dc7cf3c\",\r\n  \"Web Plan Contributor\": \"2cc479cb-7b4d-49a8-b449-8c00fd0f0a4b\",\r\n  \"Website Contributor\": \"de139f84-1756-47ae-9be6-808fbbe84772\",\r\n  \"Workbook Contributor\": \"e8ddcd69-c73f-4f9f-9844-4100522f16ad\"\r\n}')]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2019-10-01",
      "name": "NetworkWatcher",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "description": {
            "value": "[parameters('description')]"
          },
          "policyName": {
            "value": "[parameters('policyName')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-08-01/managementGroupDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.613.9944",
              "templateHash": "6179438373473318271"
            }
          },
          "parameters": {
            "mode": {
              "type": "string",
              "defaultValue": "Indexed"
            },
            "description": {
              "type": "string"
            },
            "policyName": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            }
          },
          "functions": [],
          "resources": [
            {
              "type": "Microsoft.Authorization/policyDefinitions",
              "apiVersion": "2020-09-01",
              "name": "[parameters('policyName')]",
              "properties": {
                "description": "[parameters('description')]",
                "displayName": "[parameters('description')]",
                "mode": "[parameters('mode')]",
                "policyRule": {
                  "if": {
                    "field": "type",
                    "equals": "Microsoft.Network/virtualNetworks"
                  },
                  "then": {
                    "effect": "DeployIfNotExists",
                    "details": {
                      "type": "Microsoft.Network/networkWatchers",
                      "resourceGroupName": "networkWatcherRG",
                      "existenceCondition": {
                        "field": "location",
                        "equals": "[[field('location')]"
                      },
                      "roleDefinitionIds": [
                        "/providers/microsoft.authorization/roleDefinitions/4d97b98b-1d4f-4787-a291-c67834d212e7"
                      ],
                      "deployment": {
                        "properties": {
                          "mode": "incremental",
                          "template": {
                            "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json",
                            "contentVersion": "1.0.0.0",
                            "parameters": {
                              "location": {
                                "type": "string"
                              }
                            },
                            "resources": [
                              {
                                "apiVersion": "2016-09-01",
                                "type": "Microsoft.Network/networkWatchers",
                                "name": "[[concat('networkWatcher_' parameters('location'))]",
                                "location": "[[parameters('location')]",
                                "tags": "[parameters('tags')]"
                              }
                            ]
                          },
                          "parameters": {
                            "location": {
                              "value": "[[field('location')]"
                            }
                          }
                        }
                      }
                    }
                  }
                },
                "parameters": {
                  "location": {
                    "type": "String"
                  },
                  "effect": {
                    "type": "String",
                    "allowedValues": [
                      "DeployIfNotExists",
                      "Disabled"
                    ],
                    "defaultValue": "DeployIfNotExists"
                  }
                }
              }
            }
          ],
          "outputs": {
            "policyId": {
              "type": "string",
              "value": "[format('Microsoft.Authorization/policyDefinitions/{0}', parameters('policyName'))]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2019-10-01",
      "name": "wait",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-08-01/managementGroupDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.613.9944",
              "templateHash": "6268910748420960403"
            }
          },
          "parameters": {
            "time": {
              "type": "string",
              "defaultValue": "[utcNow()]"
            }
          },
          "functions": [],
          "variables": {
            "uniqueName": "[guid(parameters('time'))]"
          },
          "resources": [
            {
              "copy": {
                "name": "delayLoop",
                "count": "[length(range(0, 15))]",
                "mode": "serial",
                "batchSize": 1
              },
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2021-04-01",
              "name": "[format('{0}-{1}', variables('uniqueName'), range(0, 15)[copyIndex()])]",
              "location": "[deployment().location]",
              "properties": {
                "mode": "Incremental",
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-08-01/managementGroupDeploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {},
                  "resources": [],
                  "outputs": {}
                }
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[format('Microsoft.Resources/deployments/{0}', 'NetworkWatcher')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2019-10-01",
      "name": "DeployPolicy",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "nonComplianceMessage": {
            "value": "[parameters('nonCompliance')]"
          },
          "policyAssignmentEnforcementMode": {
            "value": "Default"
          },
          "policyAssignmentName": {
            "value": "[parameters('assignmentName')]"
          },
          "policyDefinitionId": {
            "value": "[reference(format('Microsoft.Resources/deployments/{0}', 'NetworkWatcher'), '2019-10-01').outputs.policyId.value]"
          },
          "policyDescription": {
            "value": "[parameters('description')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-08-01/managementGroupDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.613.9944",
              "templateHash": "4092889373440418278"
            }
          },
          "parameters": {
            "policyAssignmentEnforcementMode": {
              "type": "string",
              "allowedValues": [
                "Default",
                "DoNotEnforce"
              ],
              "metadata": {
                "description": "Input will determine if the policyAssignment should be enforced or not."
              }
            },
            "policyDefinitionId": {
              "type": "string"
            },
            "policyAssignmentName": {
              "type": "string"
            },
            "policyDescription": {
              "type": "string"
            },
            "policyParameters": {
              "type": "object",
              "defaultValue": {}
            },
            "exclusions": {
              "type": "array",
              "defaultValue": []
            },
            "nonComplianceMessage": {
              "type": "string"
            },
            "location": {
              "type": "string"
            }
          },
          "functions": [],
          "resources": [
            {
              "type": "Microsoft.Authorization/policyAssignments",
              "apiVersion": "2020-09-01",
              "name": "[parameters('policyAssignmentName')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "location": "[parameters('location')]",
              "properties": {
                "description": "[parameters('policyDescription')]",
                "displayName": "[parameters('policyDescription')]",
                "policyDefinitionId": "[parameters('policyDefinitionId')]",
                "enforcementMode": "[parameters('policyAssignmentEnforcementMode')]",
                "parameters": "[parameters('policyParameters')]",
                "notScopes": "[parameters('exclusions')]",
                "nonComplianceMessages": [
                  {
                    "message": "[parameters('nonComplianceMessage')]"
                  }
                ]
              }
            }
          ],
          "outputs": {
            "policyIdentity": {
              "type": "string",
              "value": "[reference(format('Microsoft.Authorization/policyAssignments/{0}', parameters('policyAssignmentName')), '2020-09-01', 'full').identity.principalId]"
            }
          }
        }
      },
      "dependsOn": [
        "[format('Microsoft.Resources/deployments/{0}', 'wait')]",
        "[format('Microsoft.Resources/deployments/{0}', 'NetworkWatcher')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2019-10-01",
      "name": "AssignRole",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "assignmentName": {
            "value": "[parameters('assignmentName')]"
          },
          "principalId": {
            "value": "[reference(format('Microsoft.Resources/deployments/{0}', 'DeployPolicy'), '2019-10-01').outputs.policyIdentity.value]"
          },
          "principalType": {
            "value": "ServicePrincipal"
          },
          "roleId": {
            "value": "[variables('roles')['Network Contributor']]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-08-01/managementGroupDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.613.9944",
              "templateHash": "15269924886017129390"
            }
          },
          "parameters": {
            "roleId": {
              "type": "string"
            },
            "assignmentName": {
              "type": "string"
            },
            "principalId": {
              "type": "string"
            },
            "principalType": {
              "type": "string",
              "allowedValues": [
                "User",
                "ServicePrincipal",
                "Group",
                "MSI"
              ]
            }
          },
          "functions": [],
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-08-01-preview",
              "name": "[guid(parameters('roleId'), parameters('assignmentName'))]",
              "properties": {
                "principalType": "[parameters('principalType')]",
                "roleDefinitionId": "[format('/providers/Microsoft.Authorization/roleDefinitions/{0}', parameters('roleId'))]",
                "principalId": "[parameters('principalId')]"
              }
            }
          ],
          "outputs": {
            "roleId": {
              "type": "string",
              "value": "[format('Microsoft.Authorization/roleAssignments/{0}', guid(parameters('roleId'), parameters('assignmentName')))]"
            }
          }
        }
      },
      "dependsOn": [
        "[format('Microsoft.Resources/deployments/{0}', 'DeployPolicy')]"
      ]
    }
  ]
}